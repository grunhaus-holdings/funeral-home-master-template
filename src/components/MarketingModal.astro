---
interface Props {
  title?: string;
  bodyText?: string;
  ctaLink?: string;
  ctaText?: string;
  showAfterDays?: number; // Days before showing again (default: 7)
}

const {
  title = "Welcome",
  bodyText = "Help us personalize your experience",
  ctaLink = "#contact",
  ctaText = "Get Started",
  showAfterDays = 7,
} = Astro.props;
---

<dialog id="marketing-modal" class="backdrop:backdrop-blur-sm backdrop:bg-black/50 rounded-lg p-0 max-w-2xl w-full mx-auto shadow-2xl border border-gray-200 fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
  <div class="bg-white rounded-lg">
    <!-- Header -->
    <div class="bg-primary text-white p-6 rounded-t-lg">
      <div class="flex justify-between items-start">
        <h2 class="text-2xl font-heading font-bold" id="modal-title">{title}</h2>
        <button 
          id="close-modal" 
          class="text-white hover:text-accent transition-colors text-2xl leading-none"
          aria-label="Close dialog"
        >
          ×
        </button>
      </div>
    </div>

    <!-- Content -->
    <div class="p-6">
      <p class="text-text mb-6" id="modal-body">{bodyText}</p>
      
      <!-- Language Toggle -->
      <div class="mb-6">
        <label class="block text-sm font-semibold text-primary mb-3">
          <span data-lang-en="Select Language">Select Language</span>
          <span data-lang-es="Seleccionar Idioma" class="hidden">Seleccionar Idioma</span>
        </label>
        <div class="flex gap-2">
          <button
            id="lang-en-btn"
            class="lang-toggle-btn active px-4 py-2 rounded-md border-2 border-primary bg-primary text-white font-semibold transition-all"
            data-lang="en"
          >
            English
          </button>
          <button
            id="lang-es-btn"
            class="lang-toggle-btn px-4 py-2 rounded-md border-2 border-gray-300 bg-white text-gray-700 font-semibold hover:border-primary transition-all"
            data-lang="es"
          >
            Español
          </button>
        </div>
      </div>

      <!-- User Type Selection -->
      <div class="mb-6">
        <label class="block text-sm font-semibold text-primary mb-3">
          <span data-lang-en="How can we best serve you?">How can we best serve you?</span>
          <span data-lang-es="¿Cómo podemos servirle mejor?" class="hidden">¿Cómo podemos servirle mejor?</span>
        </label>
        <div class="space-y-3">
          <label for="user-type-veteran" class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-accent transition-colors user-type-option">
            <input type="radio" id="user-type-veteran" name="user-type" value="veteran" class="mr-3 w-4 h-4 text-accent focus:ring-accent" />
            <span>
              <span data-lang-en="I am a Veteran or family member of a Veteran">I am a Veteran or family member of a Veteran</span>
              <span data-lang-es="Soy un Veterano o familiar de un Veterano" class="hidden">Soy un Veterano o familiar de un Veterano</span>
            </span>
          </label>
          <label for="user-type-catholic" class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-accent transition-colors user-type-option">
            <input type="radio" id="user-type-catholic" name="user-type" value="catholic" class="mr-3 w-4 h-4 text-accent focus:ring-accent" />
            <span>
              <span data-lang-en="I am interested in Catholic services">I am interested in Catholic services</span>
              <span data-lang-es="Estoy interesado en servicios católicos" class="hidden">Estoy interesado en servicios católicos</span>
            </span>
          </label>
          <label for="user-type-general" class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-accent transition-colors user-type-option">
            <input type="radio" id="user-type-general" name="user-type" value="general" class="mr-3 w-4 h-4 text-accent focus:ring-accent" />
            <span>
              <span data-lang-en="General services">General services</span>
              <span data-lang-es="Servicios generales" class="hidden">Servicios generales</span>
            </span>
          </label>
        </div>
      </div>

      <!-- Disclaimer -->
      <p class="text-xs text-text/70 italic mb-6">
        <span data-lang-en="We're not collecting data - this just helps us improve your experience on our website.">We're not collecting data - this just helps us improve your experience on our website.</span>
        <span data-lang-es="No estamos recopilando datos; esto solo nos ayuda a mejorar su experiencia en nuestro sitio web." class="hidden">No estamos recopilando datos; esto solo nos ayuda a mejorar su experiencia en nuestro sitio web.</span>
      </p>

      <!-- CTA Button -->
      <div class="flex gap-3">
        <a
          href={ctaLink}
          id="modal-cta"
          class="flex-1 bg-accent hover:bg-accent-dark text-white px-6 py-3 rounded-md font-semibold text-center transition-colors"
        >
          <span data-lang-en={ctaText}>Get Started</span>
          <span data-lang-es="Comenzar" class="hidden">Comenzar</span>
        </a>
        <button
          id="skip-modal"
          class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-md font-semibold hover:border-primary hover:text-primary transition-colors"
        >
          <span data-lang-en="Skip">Skip</span>
          <span data-lang-es="Omitir" class="hidden">Omitir</span>
        </button>
      </div>
    </div>
  </div>
</dialog>

<script define:vars={{ showAfterDays }}>
  (function() {
    let modal, closeBtn, skipBtn, langEnBtn, langEsBtn, userTypeOptions, ctaLink;
    let currentLang = 'en';

    // Wait for DOM to be ready
    function init() {
      modal = document.getElementById('marketing-modal');
      closeBtn = document.getElementById('close-modal');
      skipBtn = document.getElementById('skip-modal');
      langEnBtn = document.getElementById('lang-en-btn');
      langEsBtn = document.getElementById('lang-es-btn');
      userTypeOptions = document.querySelectorAll('input[name="user-type"]');
      ctaLink = document.getElementById('modal-cta');
      
      if (!modal) {
        console.error('Marketing modal element not found');
        return;
      }

      // Check if modal should be shown
      function shouldShowModal() {
        const lastShown = localStorage.getItem('marketing-modal-last-shown');
        if (!lastShown) return true;
        
        const lastShownDate = new Date(lastShown);
        const daysSince = (Date.now() - lastShownDate.getTime()) / (1000 * 60 * 60 * 24);
        return daysSince >= showAfterDays;
      }

      // Show modal if conditions are met
      function showModal() {
        if (shouldShowModal() && modal) {
          modal.showModal();
        }
      }

      // Close modal and save timestamp
      function closeModal() {
        if (modal) {
          modal.close();
          localStorage.setItem('marketing-modal-last-shown', new Date().toISOString());
        }
      }

      // Language toggle
      function switchLanguage(lang) {
        currentLang = lang;
        
        // Update button states
        if (lang === 'en') {
          if (langEnBtn) {
            langEnBtn.classList.add('active', 'bg-primary', 'border-primary', 'text-white');
            langEnBtn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
          }
          if (langEsBtn) {
            langEsBtn.classList.remove('active', 'bg-primary', 'border-primary', 'text-white');
            langEsBtn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
          }
        } else {
          if (langEsBtn) {
            langEsBtn.classList.add('active', 'bg-primary', 'border-primary', 'text-white');
            langEsBtn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
          }
          if (langEnBtn) {
            langEnBtn.classList.remove('active', 'bg-primary', 'border-primary', 'text-white');
            langEnBtn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
          }
        }

        // Toggle text visibility
        document.querySelectorAll('[data-lang-en], [data-lang-es]').forEach((el) => {
          const enText = el.getAttribute('data-lang-en');
          const esText = el.getAttribute('data-lang-es');
          
          if (lang === 'en') {
            if (enText) {
              el.textContent = enText;
              el.classList.remove('hidden');
            } else if (esText) {
              el.classList.add('hidden');
            }
          } else {
            if (esText) {
              el.textContent = esText;
              el.classList.remove('hidden');
            } else if (enText) {
              el.classList.add('hidden');
            }
          }
        });
      }

      // Handle user type selection
      function handleUserTypeSelection() {
        userTypeOptions.forEach((option) => {
          option.addEventListener('change', (e) => {
            const selectedType = e.target.value;
            localStorage.setItem('user-preferred-type', selectedType);
          });
        });
      }

      // Handle modal redirect
      function handleModalRedirect() {
        const selectedType = document.querySelector('input[name="user-type"]:checked')?.value || 'general';
        const selectedLang = currentLang;
        
        let redirectPath = '/';
        
        if (selectedType === 'veteran') {
          redirectPath = selectedLang === 'es' ? '/veteran-es' : '/veteran';
        } else if (selectedType === 'catholic') {
          redirectPath = selectedLang === 'es' ? '/catholic-es' : '/catholic';
        } else {
          redirectPath = selectedLang === 'es' ? '/es' : '/';
        }
        
        // Save preferences
        localStorage.setItem('user-preferred-type', selectedType);
        localStorage.setItem('user-preferred-lang', selectedLang);
        localStorage.setItem('marketing-modal-last-shown', new Date().toISOString());
        
        // Redirect
        window.location.href = redirectPath;
      }

      // Make function globally available
      window.handleModalRedirect = handleModalRedirect;

      // Event listeners
      if (closeBtn) closeBtn.addEventListener('click', closeModal);
      if (skipBtn) skipBtn.addEventListener('click', closeModal);
      if (langEnBtn) langEnBtn.addEventListener('click', () => switchLanguage('en'));
      if (langEsBtn) langEsBtn.addEventListener('click', () => switchLanguage('es'));
      
      // Close on backdrop click
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal();
          }
        });

        // Close on Escape key
        modal.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            closeModal();
          }
        });
      }

      // Initialize
      handleUserTypeSelection();
      
      // Add click handler to CTA button
      if (ctaLink) {
        ctaLink.addEventListener('click', (e) => {
          e.preventDefault();
          handleModalRedirect();
        });
      }
      
      // Show modal after a short delay (better UX)
      setTimeout(() => {
        showModal();
      }, 1000);
    }

    // Wait for DOM to be fully loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      // DOM is already loaded
      init();
    }
  })();
</script>

<style>
  dialog::backdrop {
    background-color: rgba(0, 0, 0, 0.5);
  }

  #marketing-modal {
    margin: 0;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .user-type-option input[type="radio"]:checked + span {
    font-weight: 600;
  }

  .user-type-option:has(input[type="radio"]:checked) {
    border-color: #b08d57;
    background-color: #f9f7f2;
  }

  @media (max-width: 768px) {
    #marketing-modal {
      max-width: calc(100% - 2rem);
      margin: 1rem;
    }
  }
</style>
